package com.fabrika.s5takip

import android.app.DatePickerDialog
import android.content.Intent
import android.content.SharedPreferences
import android.os.Bundle
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.FileProvider
import com.fabrika.s5takip.databinding.ActivityReportBinding
import com.itextpdf.text.*
import com.itextpdf.text.pdf.PdfPCell
import com.itextpdf.text.pdf.PdfPTable
import com.itextpdf.text.pdf.PdfWriter
import java.io.File
import java.io.FileOutputStream
import java.text.SimpleDateFormat
import java.util.*

/**
 * Rapor olu≈üturma ekranƒ±
 * Denetmenler g√ºnl√ºk/haftalƒ±k/aylƒ±k raporlarƒ± PDF olarak olu≈üturup payla≈üabilir
 */
class ReportActivity : AppCompatActivity() {

    private lateinit var binding: ActivityReportBinding
    private lateinit var databaseHelper: DatabaseHelper
    private lateinit var sharedPreferences: SharedPreferences

    private var currentUser: User? = null
    private var selectedDate: String = getCurrentDate()
    private var reportType: ReportType = ReportType.DAILY
    private var reportData: ReportData? = null

    enum class ReportType {
        DAILY, WEEKLY, MONTHLY
    }

    data class ReportData(
        val title: String,
        val period: String,
        val problems: List<Problem>,
        val stats: DailyStats,
        val generatedBy: String,
        val generatedAt: String
    )

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityReportBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // Ba≈ülangƒ±√ß ayarlarƒ±
        initializeComponents()
        loadCurrentUser()
        setupClickListeners()
        updateDateDisplay()
        generatePreview()

        // Ba≈ülƒ±k √ßubuƒüunu ayarla
        supportActionBar?.title = "Rapor Olu≈ütur"
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
    }

    /**
     * Bile≈üenleri ba≈ülat
     */
    private fun initializeComponents() {
        databaseHelper = DatabaseHelper(this)
        sharedPreferences = getSharedPreferences("s5_takip_prefs", MODE_PRIVATE)
    }

    /**
     * Mevcut kullanƒ±cƒ±yƒ± y√ºkle
     */
    private fun loadCurrentUser() {
        val userId = sharedPreferences.getString("current_user_id", null)
        if (userId != null) {
            currentUser = databaseHelper.getUserById(userId)
        }

        // Eƒüer kullanƒ±cƒ± yoksa veya denetmen deƒüilse, geri d√∂n
        if (currentUser == null || currentUser?.role != UserRole.AUDITOR) {
            Toast.makeText(this, "Bu i≈ülem i√ßin denetmen yetkisi gerekli", Toast.LENGTH_SHORT).show()
            finish()
            return
        }
    }

    /**
     * Tƒ±klama olaylarƒ±nƒ± ayarla
     */
    private fun setupClickListeners() {
        // Rapor t√ºr√º se√ßimi
        binding.rgReportType.setOnCheckedChangeListener { _, checkedId ->
            reportType = when (checkedId) {
                R.id.rb_weekly -> ReportType.WEEKLY
                R.id.rb_monthly -> ReportType.MONTHLY
                else -> ReportType.DAILY
            }
            updateDateDisplay()
            generatePreview()
        }

        // Tarih se√ßimi
        binding.btnSelectDate.setOnClickListener {
            showDatePicker()
        }

        // Rapor √∂nizleme
        binding.btnPreviewReport.setOnClickListener {
            generatePreview()
        }

        // PDF olu≈üturma - Geli≈ümi≈ü fotoƒüraflƒ± versiyon
        binding.btnGeneratePdf.setOnClickListener {
            generateAdvancedPdfReport()
        }

        // Rapor payla≈üma
        binding.btnShareReport.setOnClickListener {
            shareReport()
        }
    }

    /**
     * Tarih se√ßici g√∂ster
     */
    private fun showDatePicker() {
        val calendar = Calendar.getInstance()
        val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())

        try {
            calendar.time = dateFormat.parse(selectedDate) ?: Date()
        } catch (e: Exception) {
            calendar.time = Date()
        }

        val datePicker = DatePickerDialog(
            this,
            { _, year, month, dayOfMonth ->
                calendar.set(year, month, dayOfMonth)
                selectedDate = dateFormat.format(calendar.time)
                updateDateDisplay()
                generatePreview()
            },
            calendar.get(Calendar.YEAR),
            calendar.get(Calendar.MONTH),
            calendar.get(Calendar.DAY_OF_MONTH)
        )

        datePicker.show()
    }

    /**
     * Tarih g√∂r√ºn√ºm√ºn√º g√ºncelle
     */
    private fun updateDateDisplay() {
        val displayFormat = SimpleDateFormat("dd MMMM yyyy", Locale("tr", "TR"))
        val inputFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())

        try {
            val date = inputFormat.parse(selectedDate) ?: Date()
            val formattedDate = displayFormat.format(date)

            val displayText = when (reportType) {
                ReportType.DAILY -> "üìÖ $formattedDate"
                ReportType.WEEKLY -> "üìÜ ${formattedDate} haftasƒ±"
                ReportType.MONTHLY -> "üóìÔ∏è ${SimpleDateFormat("MMMM yyyy", Locale("tr", "TR")).format(date)}"
            }

            binding.tvSelectedDate.text = displayText
        } catch (e: Exception) {
            binding.tvSelectedDate.text = "Bug√ºn"
        }
    }

    /**
     * Rapor √∂nizlemesi olu≈ütur
     */
    private fun generatePreview() {
        try {
            // Rapor verilerini hazƒ±rla
            val problems = getProblemsForPeriod()
            val stats = calculateStats(problems)

            reportData = ReportData(
                title = getReportTitle(),
                period = binding.tvSelectedDate.text.toString(),
                problems = problems,
                stats = stats,
                generatedBy = currentUser?.name ?: "Bilinmeyen",
                generatedAt = getCurrentDate()
            )

            // √ñnizleme verilerini g√ºncelle
            binding.tvPreviewTotal.text = stats.totalProblems.toString()
            binding.tvPreviewResolved.text = (stats.resolvedProblems + stats.verifiedProblems).toString()
            binding.tvPreviewRate.text = "${stats.resolutionRate.toInt()}%"

            // Problem listesi √∂nizlemesi
            val problemsText = if (problems.isEmpty()) {
                "Bu d√∂nemde problem bulunmuyor"
            } else {
                problems.take(3).joinToString("\n") {
                    "‚Ä¢ ${it.description.take(50)}${if (it.description.length > 50) "..." else ""}"
                } + if (problems.size > 3) "\n... ve ${problems.size - 3} problem daha" else ""
            }

            binding.tvPreviewProblems.text = problemsText

            // Butonlarƒ± aktif et
            val hasData = problems.isNotEmpty()
            binding.btnGeneratePdf.isEnabled = hasData
            binding.btnShareReport.isEnabled = hasData

            if (!hasData) {
                Toast.makeText(this, "Se√ßilen d√∂nemde problem bulunmuyor", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Toast.makeText(this, "√ñnizleme olu≈üturulurken hata: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * Belirtilen d√∂neme ait problemleri getir
     */
    private fun getProblemsForPeriod(): List<Problem> {
        return when (reportType) {
            ReportType.DAILY -> {
                databaseHelper.getProblemsForDate(selectedDate)
            }
            ReportType.WEEKLY -> {
                // Haftalƒ±k: Se√ßilen tarihten 7 g√ºn geriye
                val problems = mutableListOf<Problem>()
                val calendar = Calendar.getInstance()
                val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())

                try {
                    calendar.time = dateFormat.parse(selectedDate) ?: Date()

                    for (i in 0 until 7) {
                        val dateStr = dateFormat.format(calendar.time)
                        problems.addAll(databaseHelper.getProblemsForDate(dateStr))
                        calendar.add(Calendar.DAY_OF_MONTH, -1)
                    }
                } catch (e: Exception) {
                    // Hata durumunda sadece bug√ºnk√º problemler
                    problems.addAll(databaseHelper.getProblemsForDate(selectedDate))
                }

                problems
            }
            ReportType.MONTHLY -> {
                // Aylƒ±k: Se√ßilen ayƒ±n t√ºm g√ºnleri (basitle≈ütirilmi≈ü)
                val problems = mutableListOf<Problem>()
                val calendar = Calendar.getInstance()
                val dateFormat = SimpleDateFormat("yyyy-MM-dd", Locale.getDefault())

                try {
                    calendar.time = dateFormat.parse(selectedDate) ?: Date()
                    calendar.set(Calendar.DAY_OF_MONTH, 1) // Ayƒ±n ba≈üƒ±

                    val month = calendar.get(Calendar.MONTH)
                    while (calendar.get(Calendar.MONTH) == month) {
                        val dateStr = dateFormat.format(calendar.time)
                        problems.addAll(databaseHelper.getProblemsForDate(dateStr))
                        calendar.add(Calendar.DAY_OF_MONTH, 1)
                    }
                } catch (e: Exception) {
                    problems.addAll(databaseHelper.getProblemsForDate(selectedDate))
                }

                problems
            }
        }
    }

    /**
     * ƒ∞statistikleri hesapla
     */
    private fun calculateStats(problems: List<Problem>): DailyStats {
        val totalProblems = problems.size
        val openProblems = problems.count { it.status == ProblemStatus.OPEN }
        val inProgressProblems = problems.count { it.status == ProblemStatus.IN_PROGRESS }
        val resolvedProblems = problems.count { it.status == ProblemStatus.RESOLVED }
        val verifiedProblems = problems.count { it.status == ProblemStatus.VERIFIED }

        return DailyStats(
            date = selectedDate,
            totalProblems = totalProblems,
            openProblems = openProblems,
            inProgressProblems = inProgressProblems,
            resolvedProblems = resolvedProblems,
            verifiedProblems = verifiedProblems
        )
    }

    /**
     * Rapor ba≈ülƒ±ƒüƒ±nƒ± olu≈ütur
     */
    private fun getReportTitle(): String {
        return when (reportType) {
            ReportType.DAILY -> "G√ºnl√ºk 5S Takip Raporu"
            ReportType.WEEKLY -> "Haftalƒ±k 5S Takip Raporu"
            ReportType.MONTHLY -> "Aylƒ±k 5S Takip Raporu"
        }
    }

    /**
     * Geli≈ümi≈ü PDF rapor olu≈ütur - KOMPAKT VERSƒ∞YON
     */
    private fun generateAdvancedPdfReport() {
        if (reportData == null) {
            Toast.makeText(this, "√ñnce rapor √∂nizlemesi olu≈üturun", Toast.LENGTH_SHORT).show()
            return
        }

        try {
            val fileName = "5S_Rapor_${selectedDate}_${System.currentTimeMillis()}.pdf"
            val file = File(getExternalFilesDir(null), fileName)

            val document = Document(PageSize.A4, 30f, 30f, 40f, 30f) // Daha k√º√ß√ºk margin
            PdfWriter.getInstance(document, FileOutputStream(file))

            document.open()

            // Ba≈ülƒ±k sayfasƒ±
            addReportHeader(document)

            // ƒ∞statistikler sayfasƒ±
            addStatisticsSection(document)

            // Problem detaylarƒ± (kompakt fotoƒüraflarla)
            addProblemsWithPhotos(document)

            document.close()

            Toast.makeText(this, "Kompakt PDF rapor olu≈üturuldu!", Toast.LENGTH_LONG).show()
            binding.btnShareReport.isEnabled = true

        } catch (e: Exception) {
            Toast.makeText(this, "PDF olu≈üturma hatasƒ±: ${e.message}", Toast.LENGTH_SHORT).show()
            e.printStackTrace()
        }
    }

    /**
     * Rapor ba≈ülƒ±ƒüƒ± ekle
     */
    private fun addReportHeader(document: Document) {
        try {
            // Ana ba≈ülƒ±k
            val titleFont = Font(Font.FontFamily.HELVETICA, 20f, Font.BOLD, BaseColor.BLUE)
            val title = Paragraph(reportData!!.title, titleFont)
            title.alignment = Element.ALIGN_CENTER
            document.add(title)

            document.add(Paragraph(" "))

            // Alt bilgiler
            val infoTable = PdfPTable(2)
            infoTable.widthPercentage = 100f

            infoTable.addCell(createInfoCell("Rapor D√∂nemi:", reportData!!.period))
            infoTable.addCell(createInfoCell("Olu≈üturan:", reportData!!.generatedBy))
            infoTable.addCell(createInfoCell("Olu≈üturma Tarihi:", formatDate(System.currentTimeMillis())))
            infoTable.addCell(createInfoCell("Departman:", currentUser?.department ?: ""))

            document.add(infoTable)
            document.add(Paragraph(" "))

        } catch (e: Exception) {
            // Hata durumunda basit ba≈ülƒ±k
            document.add(Paragraph(reportData!!.title))
            document.add(Paragraph(" "))
        }
    }

    /**
     * ƒ∞statistikler b√∂l√ºm√º ekle
     */
    private fun addStatisticsSection(document: Document) {
        try {
            // ƒ∞statistik ba≈ülƒ±ƒüƒ±
            val statsTitle = Paragraph("GENEL ƒ∞STATƒ∞STƒ∞KLER", Font(Font.FontFamily.HELVETICA, 16f, Font.BOLD))
            statsTitle.alignment = Element.ALIGN_CENTER
            document.add(statsTitle)
            document.add(Paragraph(" "))

            // ƒ∞statistik tablosu
            val statsTable = PdfPTable(4)
            statsTable.widthPercentage = 100f

            // Ba≈ülƒ±k satƒ±rƒ±
            statsTable.addCell(createHeaderCell("Toplam"))
            statsTable.addCell(createHeaderCell("A√ßƒ±k"))
            statsTable.addCell(createHeaderCell("√á√∂z√ºlen"))
            statsTable.addCell(createHeaderCell("Ba≈üarƒ±"))

            // Veri satƒ±rƒ±
            statsTable.addCell(createDataCell("${reportData!!.stats.totalProblems}"))
            statsTable.addCell(createDataCell("${reportData!!.stats.openProblems}"))
            statsTable.addCell(createDataCell("${reportData!!.stats.resolvedProblems + reportData!!.stats.verifiedProblems}"))
            statsTable.addCell(createDataCell("%${reportData!!.stats.resolutionRate.toInt()}"))

            document.add(statsTable)
            document.add(Paragraph(" "))
            document.add(Paragraph(" "))

        } catch (e: Exception) {
            // Basit istatistik
            document.add(Paragraph("Toplam Problem: ${reportData!!.stats.totalProblems}"))
            document.add(Paragraph("√á√∂z√ºlen: ${reportData!!.stats.resolvedProblems + reportData!!.stats.verifiedProblems}"))
            document.add(Paragraph(" "))
        }
    }

    /**
     * Problemleri fotoƒüraflarla ekle - KOMPAKT VERSƒ∞YON
     */
    private fun addProblemsWithPhotos(document: Document) {
        if (reportData!!.problems.isEmpty()) {
            document.add(Paragraph("Bu d√∂nemde problem bulunmuyor."))
            return
        }

        try {
            val problemsTitle = Paragraph("PROBLEM DETAYLARI", Font(Font.FontFamily.HELVETICA, 16f, Font.BOLD))
            problemsTitle.alignment = Element.ALIGN_CENTER
            document.add(problemsTitle)
            document.add(Paragraph(" "))

            reportData!!.problems.forEachIndexed { index, problem ->
                // Sadece 1. problem i√ßin yeni sayfa deƒüil, diƒüerleri i√ßin kontroll√º bo≈üluk
                if (index > 0) {
                    // Sayfa sonuna yakƒ±nsa yeni sayfa, deƒüilse sadece bo≈üluk
                    document.add(Paragraph(" "))
                    document.add(Paragraph("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"))
                    document.add(Paragraph(" "))
                }

                addCompactProblemWithPhotos(document, problem, index + 1)
            }

        } catch (e: Exception) {
            // Basit problem listesi
            reportData!!.problems.forEachIndexed { index, problem ->
                document.add(Paragraph("${index + 1}. ${problem.description}"))
                document.add(Paragraph("Konum: ${problem.location}"))
                document.add(Paragraph(" "))
            }
        }
    }
    /**
     * Tek bir problemi KOMPAKT ≈üekilde ekle
     */
    private fun addCompactProblemWithPhotos(document: Document, problem: Problem, problemNumber: Int) {
        try {
            // Problem ba≈ülƒ±ƒüƒ± - daha k√º√ß√ºk
            val problemTitle = Paragraph("Problem #$problemNumber", Font(Font.FontFamily.HELVETICA, 12f, Font.BOLD))
            document.add(problemTitle)

            // Problem bilgileri - tek satƒ±rda
            val infoText = "A√ßƒ±klama: ${problem.description} | Konum: ${problem.location} | Durum: ${problem.status.toTurkish()}"
            document.add(Paragraph(infoText, Font(Font.FontFamily.HELVETICA, 9f)))
            document.add(Paragraph(" "))

            // FOTOƒûRAFLAR - Daha k√º√ß√ºk boyutlarda
            addCompactPhotoSection(document, problem)

            // √á√ñZ√úMLER - Daha kƒ±sa
            addCompactSolutionsSection(document, problem)

        } catch (e: Exception) {
            // Basit problem bilgisi
            document.add(Paragraph("Problem $problemNumber: ${problem.description}"))
        }
    }

    /**
     * Tek bir problemi fotoƒüraflarƒ±yla ekle
     */
    private fun addSingleProblemWithPhotos(document: Document, problem: Problem, problemNumber: Int) {
        try {
            // Problem ba≈ülƒ±ƒüƒ±
            val problemTitle = Paragraph("Problem #$problemNumber", Font(Font.FontFamily.HELVETICA, 14f, Font.BOLD))
            document.add(problemTitle)
            document.add(Paragraph(" "))

            // Problem bilgileri
            document.add(Paragraph("A√ßƒ±klama: ${problem.description}"))
            document.add(Paragraph("Konum: ${problem.location}"))
            document.add(Paragraph("Durum: ${problem.status.toTurkish()}"))
            document.add(Paragraph("Denetmen: ${problem.auditorName}"))
            document.add(Paragraph(" "))

            // FOTOƒûRAFLAR - Sol: Problem, Saƒü: √á√∂z√ºm
            addPhotoSection(document, problem)

            // √á√ñZ√úM √ñNERƒ∞LERƒ∞
            addSolutionsSection(document, problem)

            document.add(Paragraph(" "))
            document.add(Paragraph("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")) // Ayƒ±rƒ±cƒ± √ßizgi
            document.add(Paragraph(" "))

        } catch (e: Exception) {
            // Basit problem bilgisi
            document.add(Paragraph("Problem $problemNumber: ${problem.description}"))
            document.add(Paragraph(" "))
        }
    }

    /**
     * Fotoƒüraf b√∂l√ºm√º - Sol: Problem, Saƒü: √á√∂z√ºm
     */
    private fun addPhotoSection(document: Document, problem: Problem) {
        try {
            val photoTitle = Paragraph("FOTOƒûRAFLAR", Font(Font.FontFamily.HELVETICA, 12f, Font.BOLD))
            document.add(photoTitle)
            document.add(Paragraph(" "))

            // 2 s√ºtunlu tablo (sol: problem, saƒü: √ß√∂z√ºm)
            val photoTable = PdfPTable(2)
            photoTable.widthPercentage = 100f
            photoTable.setWidths(floatArrayOf(1f, 1f)) // E≈üit geni≈ülik

            // Sol: Problem fotoƒürafƒ±
            val problemCell = PdfPCell()
            problemCell.addElement(Paragraph("Problem Fotoƒürafƒ±:", Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD)))

            if (problem.imagePath.isNotEmpty() && File(problem.imagePath).exists()) {
                try {
                    val problemImage = Image.getInstance(problem.imagePath)
                    problemImage.scaleToFit(200f, 150f)
                    problemCell.addElement(problemImage)
                } catch (e: Exception) {
                    problemCell.addElement(Paragraph("Fotoƒüraf y√ºklenemedi"))
                }
            } else {
                problemCell.addElement(Paragraph("Fotoƒüraf yok"))
            }

            // Saƒü: √á√∂z√ºm fotoƒürafƒ±
            val solutionCell = PdfPCell()
            solutionCell.addElement(Paragraph("√á√∂z√ºm Fotoƒürafƒ±:", Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD)))

            // En son √ß√∂z√ºm√ºn fotoƒürafƒ±nƒ± al
            val solutions = databaseHelper.getSolutionsForProblem(problem.id)
            val lastSolutionWithPhoto = solutions.lastOrNull { it.imagePath.isNotEmpty() }

            if (lastSolutionWithPhoto != null && File(lastSolutionWithPhoto.imagePath).exists()) {
                try {
                    val solutionImage = Image.getInstance(lastSolutionWithPhoto.imagePath)
                    solutionImage.scaleToFit(200f, 150f)
                    solutionCell.addElement(solutionImage)
                } catch (e: Exception) {
                    solutionCell.addElement(Paragraph("Fotoƒüraf y√ºklenemedi"))
                }
            } else {
                solutionCell.addElement(Paragraph("√á√∂z√ºm fotoƒürafƒ± yok"))
            }

            photoTable.addCell(problemCell)
            photoTable.addCell(solutionCell)

            document.add(photoTable)
            document.add(Paragraph(" "))

        } catch (e: Exception) {
            document.add(Paragraph("Fotoƒüraflar y√ºklenemedi"))
            document.add(Paragraph(" "))
        }
    }
    /**
     * Kompakt fotoƒüraf b√∂l√ºm√º - Daha k√º√ß√ºk boyutlar
     */
    private fun addCompactPhotoSection(document: Document, problem: Problem) {
        try {
            // 2 s√ºtunlu tablo (sol: problem, saƒü: √ß√∂z√ºm) - daha k√º√ß√ºk
            val photoTable = PdfPTable(2)
            photoTable.widthPercentage = 90f
            photoTable.setWidths(floatArrayOf(1f, 1f))

            // Sol: Problem fotoƒürafƒ± - K√ú√á√úK
            val problemCell = PdfPCell()
            problemCell.addElement(Paragraph("Problem:", Font(Font.FontFamily.HELVETICA, 8f, Font.BOLD)))

            if (problem.imagePath.isNotEmpty() && File(problem.imagePath).exists()) {
                try {
                    val problemImage = Image.getInstance(problem.imagePath)
                    problemImage.scaleToFit(120f, 90f) // Daha k√º√ß√ºk boyut
                    problemCell.addElement(problemImage)
                } catch (e: Exception) {
                    problemCell.addElement(Paragraph("Fotoƒüraf yok", Font(Font.FontFamily.HELVETICA, 8f)))
                }
            } else {
                problemCell.addElement(Paragraph("Fotoƒüraf yok", Font(Font.FontFamily.HELVETICA, 8f)))
            }
            problemCell.minimumHeight = 100f

            // Saƒü: √á√∂z√ºm fotoƒürafƒ± - K√ú√á√úK
            val solutionCell = PdfPCell()
            solutionCell.addElement(Paragraph("√á√∂z√ºm:", Font(Font.FontFamily.HELVETICA, 8f, Font.BOLD)))

            // En son √ß√∂z√ºm√ºn fotoƒürafƒ±nƒ± al
            val solutions = databaseHelper.getSolutionsForProblem(problem.id)
            val lastSolutionWithPhoto = solutions.lastOrNull { it.imagePath.isNotEmpty() }

            if (lastSolutionWithPhoto != null && File(lastSolutionWithPhoto.imagePath).exists()) {
                try {
                    val solutionImage = Image.getInstance(lastSolutionWithPhoto.imagePath)
                    solutionImage.scaleToFit(120f, 90f) // Daha k√º√ß√ºk boyut
                    solutionCell.addElement(solutionImage)
                } catch (e: Exception) {
                    solutionCell.addElement(Paragraph("Fotoƒüraf yok", Font(Font.FontFamily.HELVETICA, 8f)))
                }
            } else {
                solutionCell.addElement(Paragraph("√á√∂z√ºm fotoƒürafƒ± yok", Font(Font.FontFamily.HELVETICA, 8f)))
            }
            solutionCell.minimumHeight = 100f

            photoTable.addCell(problemCell)
            photoTable.addCell(solutionCell)

            document.add(photoTable)

        } catch (e: Exception) {
            document.add(Paragraph("Fotoƒüraflar y√ºklenemedi", Font(Font.FontFamily.HELVETICA, 8f)))
        }
    }

    /**
     * Kompakt √ß√∂z√ºm √∂nerileri b√∂l√ºm√º
     */
    private fun addCompactSolutionsSection(document: Document, problem: Problem) {
        try {
            val solutions = databaseHelper.getSolutionsForProblem(problem.id)

            if (solutions.isNotEmpty()) {
                val solutionsTitle = Paragraph("√á√∂z√ºmler (${solutions.size}):",
                    Font(Font.FontFamily.HELVETICA, 9f, Font.BOLD))
                document.add(solutionsTitle)

                // En fazla 2 √ß√∂z√ºm g√∂ster, daha kƒ±sa
                solutions.take(2).forEachIndexed { index, solution ->
                    val shortDesc = if (solution.description.length > 80) {
                        solution.description.take(80) + "..."
                    } else {
                        solution.description
                    }

                    document.add(Paragraph("${index + 1}. $shortDesc (${solution.userName})",
                        Font(Font.FontFamily.HELVETICA, 8f)))
                }

                if (solutions.size > 2) {
                    document.add(Paragraph("... ve ${solutions.size - 2} √ß√∂z√ºm daha",
                        Font(Font.FontFamily.HELVETICA, 8f, Font.ITALIC)))
                }
            } else {
                document.add(Paragraph("√á√∂z√ºm √∂nerisi yok.", Font(Font.FontFamily.HELVETICA, 8f)))
            }

        } catch (e: Exception) {
            document.add(Paragraph("√á√∂z√ºmler y√ºklenemedi", Font(Font.FontFamily.HELVETICA, 8f)))
        }
    }

    /**
     * √á√∂z√ºm √∂nerileri b√∂l√ºm√º
     */
    private fun addSolutionsSection(document: Document, problem: Problem) {
        try {
            val solutions = databaseHelper.getSolutionsForProblem(problem.id)

            if (solutions.isNotEmpty()) {
                val solutionsTitle = Paragraph("√á√ñZ√úM √ñNERƒ∞LERƒ∞ (${solutions.size} adet):",
                    Font(Font.FontFamily.HELVETICA, 12f, Font.BOLD))
                document.add(solutionsTitle)
                document.add(Paragraph(" "))

                solutions.forEachIndexed { index, solution ->
                    document.add(Paragraph("${index + 1}. ${solution.description}"))
                    document.add(Paragraph("   √ñneren: ${solution.userName}"))
                    document.add(Paragraph("   Tarih: ${formatDate(solution.createdAt)}"))
                    if (solution.isVerified) {
                        document.add(Paragraph("   ‚úì Denetmen tarafƒ±ndan onaylandƒ±"))
                    }
                    document.add(Paragraph(" "))
                }
            } else {
                document.add(Paragraph("Hen√ºz √ß√∂z√ºm √∂nerisi bulunmuyor."))
                document.add(Paragraph(" "))
            }

        } catch (e: Exception) {
            document.add(Paragraph("√á√∂z√ºmler y√ºklenemedi"))
            document.add(Paragraph(" "))
        }
    }

    /**
     * Raporu payla≈ü
     */
    private fun shareReport() {
        try {
            // En son olu≈üturulan PDF'i bul
            val filesDir = getExternalFilesDir(null)
            val pdfFiles = filesDir?.listFiles { file ->
                file.name.startsWith("5S_Rapor_") && file.name.endsWith(".pdf")
            }?.sortedByDescending { it.lastModified() }

            if (pdfFiles.isNullOrEmpty()) {
                Toast.makeText(this, "√ñnce PDF rapor olu≈üturun", Toast.LENGTH_SHORT).show()
                return
            }

            val latestPdf = pdfFiles.first()
            val uri = FileProvider.getUriForFile(
                this,
                "${packageName}.fileprovider",
                latestPdf
            )

            val shareIntent = Intent(Intent.ACTION_SEND).apply {
                type = "application/pdf"
                putExtra(Intent.EXTRA_STREAM, uri)
                putExtra(Intent.EXTRA_SUBJECT, "5S Takip Raporu")
                putExtra(Intent.EXTRA_TEXT, "5S Takip sistemi tarafƒ±ndan olu≈üturulan rapor.")
                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
            }

            startActivity(Intent.createChooser(shareIntent, "Raporu Payla≈ü"))

        } catch (e: Exception) {
            Toast.makeText(this, "Payla≈üƒ±m hatasƒ±: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }

    /**
     * Yardƒ±mcƒ± fonksiyonlar
     */
    private fun createInfoCell(label: String, value: String): PdfPCell {
        val cell = PdfPCell()
        cell.addElement(Paragraph("$label $value", Font(Font.FontFamily.HELVETICA, 10f)))
        cell.border = Rectangle.NO_BORDER
        return cell
    }

    private fun createHeaderCell(text: String): PdfPCell {
        val cell = PdfPCell(Phrase(text, Font(Font.FontFamily.HELVETICA, 10f, Font.BOLD)))
        cell.backgroundColor = BaseColor.LIGHT_GRAY
        cell.horizontalAlignment = Element.ALIGN_CENTER
        return cell
    }

    private fun createDataCell(text: String): PdfPCell {
        val cell = PdfPCell(Phrase(text, Font(Font.FontFamily.HELVETICA, 10f)))
        cell.horizontalAlignment = Element.ALIGN_CENTER
        return cell
    }

    /**
     * Geri buton basƒ±ldƒ±ƒüƒ±nda
     */
    override fun onSupportNavigateUp(): Boolean {
        onBackPressed()
        return true
    }
}