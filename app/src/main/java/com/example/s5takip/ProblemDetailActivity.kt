package com.fabrika.s5takip

import android.content.Intent
import android.content.SharedPreferences
import android.os.Bundle
import android.view.View
import android.widget.LinearLayout
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.LinearLayoutManager
import com.fabrika.s5takip.databinding.ActivityProblemDetailBinding
import com.google.firebase.auth.FirebaseAuth

/**
 * Problem detay ekranƒ±
 * Problemin t√ºm bilgilerini ve √ß√∂z√ºmlerini g√∂sterir
 */
class ProblemDetailActivity : AppCompatActivity() {

    private lateinit var binding: ActivityProblemDetailBinding
    private lateinit var databaseHelper: DatabaseHelper
    private lateinit var photoManager: PhotoManager
    private lateinit var sharedPreferences: SharedPreferences

    private var currentUser: User? = null
    private var problem: Problem? = null
    private var solutions = mutableListOf<Solution>()

    companion object {
        const val EXTRA_PROBLEM_ID = "problem_id"
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityProblemDetailBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // Ba≈ülangƒ±√ß ayarlarƒ±
        initializeComponents()
        loadCurrentUser()
        loadProblem()
        setupClickListeners()

        // Ba≈ülƒ±k √ßubuƒüunu ayarla
        supportActionBar?.title = "Problem Detayƒ±"
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
    }

    /**
     * Bile≈üenleri ba≈ülat
     */
    private fun initializeComponents() {
        databaseHelper = DatabaseHelper(this)
        photoManager = PhotoManager(this)
        sharedPreferences = getSharedPreferences("s5_takip_prefs", MODE_PRIVATE)
    }

    /**
     * Mevcut kullanƒ±cƒ±yƒ± y√ºkle
     */
    private fun loadCurrentUser() {
        val userId = sharedPreferences.getString("current_user_id", null)
        if (userId != null) {
            currentUser = databaseHelper.getUserById(userId)
        }

        if (currentUser == null) {
            Toast.makeText(this, "Kullanƒ±cƒ± bilgisi bulunamadƒ±", Toast.LENGTH_SHORT).show()
            finish()
            return
        }
    }

    /**
     * Problem bilgilerini y√ºkle
     */
    private fun loadProblem() {
        val problemId = intent.getStringExtra(EXTRA_PROBLEM_ID)
        if (problemId == null) {
            Toast.makeText(this, "Problem bilgisi bulunamadƒ±", Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        // Problem'i veritabanƒ±ndan bul
        val problems = databaseHelper.getProblemsForDate(getCurrentDate())
        problem = problems.find { it.id == problemId }

        if (problem == null) {
            Toast.makeText(this, "Problem bulunamadƒ±", Toast.LENGTH_SHORT).show()
            finish()
            return
        }

        // Problem bilgilerini ekranda g√∂ster
        displayProblemInfo()

        // √á√∂z√ºmleri y√ºkle
        loadSolutions()
    }

    /**
     * Problem bilgilerini ekranda g√∂ster - DENETMENƒ∞N ADINI G√ñSTER
     */
    private fun displayProblemInfo() {
        if (problem == null) return

        binding.tvDetailProblemId.text = "Problem #${problem!!.id.take(8)}"
        binding.tvDetailStatus.text = problem!!.status.toTurkish()
        binding.tvDetailDescription.text = problem!!.description
        binding.tvDetailLocation.text = problem!!.location

        // ‚úÖ Problemin ger√ßek denetmenini g√∂ster
        binding.tvDetailAuditor.text = problem!!.auditorName
        binding.tvDetailPriority.text = problem!!.priority.toTurkish()

        // Tarih formatla
        binding.tvDetailDate.text = formatDate(problem!!.createdAt)

        // Durum rengini ayarla
        val statusColor = getStatusColor(problem!!.status)
        binding.tvDetailStatus.setBackgroundColor(statusColor)

        // Problem fotoƒürafƒ±nƒ± y√ºkle
        if (problem!!.imagePath.isNotEmpty()) {
            photoManager.loadPhoto(problem!!.imagePath, binding.ivDetailProblemPhoto)
        } else {
            binding.ivDetailProblemPhoto.setImageResource(android.R.drawable.ic_menu_gallery)
        }

        println("DEBUG: Problem bilgileri g√ºncellendi - Denetmen: ${problem!!.auditorName}")
    }

    /**
     * √á√∂z√ºmleri y√ºkle - G√ºncellenmi≈ü versiyon
     */
    private fun loadSolutions() {
        if (problem == null) return

        try {
            val loadedSolutions = databaseHelper.getSolutionsForProblem(problem!!.id)
            solutions.clear()
            solutions.addAll(loadedSolutions)

            // Debug i√ßin log ekle
            println("DEBUG: Problem ID: ${problem!!.id}")
            println("DEBUG: Bulunan √ß√∂z√ºm sayƒ±sƒ±: ${solutions.size}")

            // √á√∂z√ºm sayƒ±sƒ±nƒ± g√ºncelle
            binding.tvSolutionsCount.text = "${solutions.size} √ß√∂z√ºm"

            if (solutions.isEmpty()) {
                binding.rvSolutions.visibility = View.GONE
                binding.llNoSolutions.visibility = View.VISIBLE
            } else {
                binding.llNoSolutions.visibility = View.GONE

                // √á√∂z√ºmleri g√∂ster
                showSolutionsInRecyclerView()
            }

        } catch (e: Exception) {
            println("DEBUG: √á√∂z√ºm y√ºkleme hatasƒ±: ${e.message}")
            Toast.makeText(this, "√á√∂z√ºmler y√ºklenirken hata: ${e.message}", Toast.LENGTH_SHORT).show()
            e.printStackTrace()
        }
    }

    /**
     * √á√∂z√ºmleri RecyclerView'da g√∂ster
     */
    private fun showSolutionsInRecyclerView() {
        if (solutions.isEmpty()) return

        binding.rvSolutions.visibility = View.VISIBLE

        // Basit bir adapter olu≈ütur
        val adapter = SolutionsAdapter(solutions, photoManager)
        binding.rvSolutions.layoutManager = LinearLayoutManager(this)
        binding.rvSolutions.adapter = adapter

        // Debug mesajƒ±
        Toast.makeText(this, "‚úÖ ${solutions.size} √ß√∂z√ºm y√ºklendi", Toast.LENGTH_SHORT).show()
    }

    /**
     * Tƒ±klama olaylarƒ±nƒ± ayarla - SADECE DENETMENLƒ∞K YETKƒ∞Sƒ∞ KONTROL√ú
     */
    private fun setupClickListeners() {
        // √á√∂z√ºm ekleme butonu - HERKESƒ∞N EKLEYEBƒ∞LMESƒ∞ ƒ∞√áƒ∞N
        binding.btnDetailAddSolution.setOnClickListener {
            if (problem != null) {
                val intent = Intent(this, AddSolutionActivity::class.java)
                intent.putExtra(AddSolutionActivity.EXTRA_PROBLEM_ID, problem!!.id)
                startActivity(intent)
            }
        }

        // ‚úÖ Durum deƒüi≈ütirme butonu - SADECE DENETMENLERƒ∞N G√ñREBƒ∞LMESƒ∞
        val currentFirebaseUser = FirebaseAuth.getInstance().currentUser
        val isDenetmen = checkIfCurrentUserIsAuditor()

        if (isDenetmen) {
            // Denetmense durum deƒüi≈ütirme butonu g√∂ster
            binding.btnDetailEditStatus.visibility = View.VISIBLE
            binding.btnDetailEditStatus.setOnClickListener {
                showStatusChangeDialog()
            }

            // Hƒ±zlƒ± durum deƒüi≈ütirme butonlarƒ± g√∂ster
            binding.cvQuickStatus.visibility = View.VISIBLE

            binding.btnStatusProgress.setOnClickListener {
                updateProblemStatus(ProblemStatus.IN_PROGRESS)
            }

            binding.btnStatusResolved.setOnClickListener {
                updateProblemStatus(ProblemStatus.RESOLVED)
            }

            binding.btnStatusVerified.setOnClickListener {
                updateProblemStatus(ProblemStatus.VERIFIED)
            }
        } else {
            // Denetmen deƒüilse durum deƒüi≈ütirme butonlarƒ±nƒ± gizle
            binding.btnDetailEditStatus.visibility = View.GONE
            binding.cvQuickStatus.visibility = View.GONE

            println("DEBUG: Normal kullanƒ±cƒ± - durum deƒüi≈ütirme yetkileri gizlendi")
        }
    }

    /**
     * Mevcut kullanƒ±cƒ±nƒ±n denetmen olup olmadƒ±ƒüƒ±nƒ± kontrol et
     */
    private fun checkIfCurrentUserIsAuditor(): Boolean {
        val currentFirebaseUser = FirebaseAuth.getInstance().currentUser
        if (currentFirebaseUser == null) return false

        // Problem sahibi denetmen mi kontrol et
        if (problem?.auditorId == currentFirebaseUser.uid) {
            println("DEBUG: Kullanƒ±cƒ± bu problemin denetmeni")
            return true
        }

        // Grup ayarlarƒ±ndan denetmenlik yetkilerini kontrol et (opsiyonel)
        // Bu kƒ±sƒ±m grup y√∂netimi sistemiyle entegre edilebilir

        println("DEBUG: Kullanƒ±cƒ± denetmen deƒüil - ID: ${currentFirebaseUser.uid}, Problem Denetmen ID: ${problem?.auditorId}")
        return false
    }

    /**
     * Durum deƒüi≈ütirme dialog'u g√∂ster
     */
    private fun showStatusChangeDialog() {
        if (problem == null) return

        val statusOptions = arrayOf(
            "üî¥ A√ßƒ±k",
            "üü° ƒ∞≈ülemde",
            "üü¢ √á√∂z√ºld√º",
            "üîµ Doƒürulandƒ±"
        )

        val statusValues = arrayOf(
            ProblemStatus.OPEN,
            ProblemStatus.IN_PROGRESS,
            ProblemStatus.RESOLVED,
            ProblemStatus.VERIFIED
        )

        // Mevcut durumun index'ini bul
        val currentIndex = statusValues.indexOf(problem!!.status)

        val builder = AlertDialog.Builder(this)
        builder.setTitle("Problem Durumunu Deƒüi≈ütir")
        builder.setMessage("Mevcut durum: ${problem!!.status.toTurkish()}\n\nYeni durum se√ßin:")

        builder.setSingleChoiceItems(statusOptions, currentIndex) { dialog, which ->
            val newStatus = statusValues[which]
            updateProblemStatus(newStatus)
            dialog.dismiss()
        }

        builder.setNegativeButton("ƒ∞ptal") { dialog, _ ->
            dialog.dismiss()
        }

        builder.create().show()
    }

    /**
     * Problem durumunu g√ºncelle - YETKƒ∞ KONTROL√ú ƒ∞LE
     */
    private fun updateProblemStatus(newStatus: ProblemStatus) {
        if (problem == null) return

        // ‚úÖ Denetmenlik kontrol√º
        if (!checkIfCurrentUserIsAuditor()) {
            Toast.makeText(this, "‚ùå Bu i≈ülem i√ßin denetmen yetkisi gerekli", Toast.LENGTH_SHORT).show()
            return
        }

        try {
            val success = databaseHelper.updateProblemStatus(problem!!.id, newStatus)

            if (success) {
                // Problem nesnesini g√ºncelle
                problem = problem!!.copy(status = newStatus)

                // Ekranƒ± yenile
                displayProblemInfo()

                // Ba≈üarƒ± mesajƒ±
                Toast.makeText(
                    this,
                    "‚úÖ Problem durumu '${newStatus.toTurkish()}' olarak g√ºncellendi",
                    Toast.LENGTH_SHORT
                ).show()

                println("DEBUG: Problem durumu g√ºncellendi: ${newStatus.toTurkish()}")

            } else {
                Toast.makeText(this, "‚ùå Durum g√ºncellenirken hata olu≈ütu", Toast.LENGTH_SHORT).show()
            }

        } catch (e: Exception) {
            Toast.makeText(this, "‚ùå Hata: ${e.message}", Toast.LENGTH_SHORT).show()
            e.printStackTrace()
        }
    }


    /**
     * Problem durumuna g√∂re renk d√∂nd√ºr
     */
    private fun getStatusColor(status: ProblemStatus): Int {
        return when (status) {
            ProblemStatus.OPEN -> ContextCompat.getColor(this, R.color.status_open)
            ProblemStatus.IN_PROGRESS -> ContextCompat.getColor(this, R.color.status_in_progress)
            ProblemStatus.RESOLVED -> ContextCompat.getColor(this, R.color.status_resolved)
            ProblemStatus.VERIFIED -> ContextCompat.getColor(this, R.color.status_verified)
        }
    }

    /**
     * Geri buton basƒ±ldƒ±ƒüƒ±nda
     */
    override fun onSupportNavigateUp(): Boolean {
        onBackPressed()
        return true
    }

    /**
     * Aktivite yeniden g√∂r√ºn√ºr olduƒüunda
     */
    override fun onResume() {
        super.onResume()

        // Problem ve √ß√∂z√ºmleri yeniden y√ºkle
        loadProblem()
    }
}

/**
 * √á√∂z√ºmler i√ßin basit adapter
 */
class SolutionsAdapter(
    private val solutions: List<Solution>,
    private val photoManager: PhotoManager
) : androidx.recyclerview.widget.RecyclerView.Adapter<SolutionsAdapter.SolutionViewHolder>() {

    class SolutionViewHolder(view: View) : androidx.recyclerview.widget.RecyclerView.ViewHolder(view) {
        val cardView: androidx.cardview.widget.CardView = view as androidx.cardview.widget.CardView
    }

    override fun onCreateViewHolder(parent: android.view.ViewGroup, viewType: Int): SolutionViewHolder {
        val context = parent.context
        val cardView = androidx.cardview.widget.CardView(context)
        val layoutParams = androidx.recyclerview.widget.RecyclerView.LayoutParams(
            androidx.recyclerview.widget.RecyclerView.LayoutParams.MATCH_PARENT,
            androidx.recyclerview.widget.RecyclerView.LayoutParams.WRAP_CONTENT
        )
        layoutParams.setMargins(0, 0, 0, 16)
        cardView.layoutParams = layoutParams
        cardView.radius = 12f
        cardView.cardElevation = 4f

        return SolutionViewHolder(cardView)
    }

    override fun onBindViewHolder(holder: SolutionViewHolder, position: Int) {
        val solution = solutions[position]
        val context = holder.itemView.context

        // ƒ∞√ß layout olu≈ütur
        val innerLayout = LinearLayout(context)
        innerLayout.orientation = LinearLayout.VERTICAL
        innerLayout.setPadding(16, 16, 16, 16)

        // Ba≈ülƒ±k
        val titleText = android.widget.TextView(context)
        titleText.text = "üí° √á√∂z√ºm ${position + 1}"
        titleText.textSize = 16f
        titleText.setTypeface(null, android.graphics.Typeface.BOLD)
        titleText.setTextColor(ContextCompat.getColor(context, R.color.primary))

        // Kullanƒ±cƒ± ve tarih
        val userText = android.widget.TextView(context)
        userText.text = "${solution.userName} ‚Ä¢ ${formatDate(solution.createdAt)}"
        userText.textSize = 12f
        userText.setTextColor(ContextCompat.getColor(context, R.color.gray_dark))

        // A√ßƒ±klama
        val descText = android.widget.TextView(context)
        descText.text = solution.description
        descText.textSize = 14f
        descText.setTextColor(android.graphics.Color.BLACK)

        // Layout'a ekle
        innerLayout.addView(titleText)

        // Bo≈üluk
        val spacer1 = android.widget.Space(context)
        spacer1.layoutParams = LinearLayout.LayoutParams(0, 8)
        innerLayout.addView(spacer1)

        innerLayout.addView(userText)

        // Bo≈üluk
        val spacer2 = android.widget.Space(context)
        spacer2.layoutParams = LinearLayout.LayoutParams(0, 12)
        innerLayout.addView(spacer2)

        innerLayout.addView(descText)

        // Fotoƒüraf varsa ekle
        if (solution.imagePath.isNotEmpty()) {
            val imageView = android.widget.ImageView(context)
            val imageParams = LinearLayout.LayoutParams(
                LinearLayout.LayoutParams.MATCH_PARENT,
                200
            )
            imageParams.setMargins(0, 12, 0, 0)
            imageView.layoutParams = imageParams
            imageView.scaleType = android.widget.ImageView.ScaleType.CENTER_CROP

            photoManager.loadPhoto(solution.imagePath, imageView)
            innerLayout.addView(imageView)
        }

        // CardView'ƒ± temizle ve yeni i√ßeriƒüi ekle
        holder.cardView.removeAllViews()
        holder.cardView.addView(innerLayout)
    }

    override fun getItemCount(): Int = solutions.size
}